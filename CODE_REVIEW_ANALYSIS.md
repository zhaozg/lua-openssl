# lua-openssl æ·±åº¦ä»£ç å®¡æŸ¥ä¸æ”¹è¿›å»ºè®®

## æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›äº†å¯¹ lua-openssl é¡¹ç›®çš„æ·±åº¦ä»£ç å®¡æŸ¥ç»“æœï¼Œé‡ç‚¹å…³æ³¨ä»¥ä¸‹å››ä¸ªæ–¹é¢ï¼š

1. **OpenSSL API çš„é”™è¯¯ä½¿ç”¨å’Œé€»è¾‘é”™è¯¯**ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
2. **OpenSSL ç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥ä¸åºŸå¼ƒæ¥å£å‡çº§**
3. **ç¼ºå¤±çš„é€šç”¨åŠ å¯†åº“åŠŸèƒ½**
4. **OpenSSL æ–°ç‰ˆæœ¬åŠŸèƒ½çš„å®ç°å»ºè®®**

---

## 1. OpenSSL API é”™è¯¯ä½¿ç”¨å’Œé€»è¾‘é”™è¯¯ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰

### é—®é¢˜ 1: é”™è¯¯å¤„ç†è·¯å¾„ä¸­çš„å†…å­˜æ³„æ¼é£é™©

**ä½ç½®ï¼š** å¤šä¸ªæ–‡ä»¶ä¸­çš„é”™è¯¯å¤„ç†ä»£ç 

**é—®é¢˜æè¿°ï¼š**
æŸäº›å‡½æ•°åœ¨é”™è¯¯è·¯å¾„ä¸Šå¯èƒ½æ²¡æœ‰æ­£ç¡®é‡Šæ”¾å·²åˆ†é…çš„èµ„æºã€‚

**ç¤ºä¾‹ï¼ˆsrc/digest.cï¼‰ï¼š**
```c
static int openssl_digest_new(lua_State *L) {
  const EVP_MD *md = get_digest(L, 1, NULL);
  int ret = 0;
  ENGINE *e = lua_isnoneornil(L, 2) ? NULL : CHECK_OBJECT(2, ENGINE, "openssl.engine");
  EVP_MD_CTX *ctx = EVP_MD_CTX_create();
  if (ctx) {
    EVP_MD_CTX_init(ctx);
    lua_pushlightuserdata(L, e);
    lua_rawsetp(L, LUA_REGISTRYINDEX, ctx);  // å¯èƒ½å¤±è´¥
    ret = EVP_DigestInit_ex(ctx, md, e);
    if (ret == 1) {
      PUSH_OBJECT(ctx, "openssl.evp_digest_ctx");
    } else {
      EVP_MD_CTX_destroy(ctx);
      ret = openssl_pushresult(L, ret);
    }
  }
  return ret;
}
```

**å»ºè®®ï¼š**
- ç¡®ä¿æ‰€æœ‰é”™è¯¯è·¯å¾„éƒ½æ­£ç¡®æ¸…ç†èµ„æº
- è€ƒè™‘ä½¿ç”¨ RAII æ¨¡å¼æˆ–ç¡®ä¿æ¯ä¸ªåˆ†é…éƒ½æœ‰å¯¹åº”çš„é‡Šæ”¾

**ä¼˜å…ˆçº§ï¼š** é«˜

### é—®é¢˜ 2: çº¿ç¨‹ç›¸å…³å…¨å±€çŠ¶æ€ç®¡ç†

**ä½ç½®ï¼š** `src/th-lock.c`

**é—®é¢˜æè¿°ï¼š**
éœ€è¦éªŒè¯å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„é”æœºåˆ¶æ˜¯å¦æ­£ç¡®å®ç°ï¼Œç‰¹åˆ«æ˜¯å¯¹äº OpenSSL 3.0+ï¼Œçº¿ç¨‹å®‰å…¨æœºåˆ¶æœ‰æ‰€æ”¹å˜ã€‚

**å»ºè®®ï¼š**
- OpenSSL 3.0+ é»˜è®¤æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ— éœ€æ˜¾å¼é”å®š
- ç¡®ä¿æ—§ç‰ˆæœ¬çš„é”å®ç°æ­£ç¡®
- æ·»åŠ çº¿ç¨‹å®‰å…¨æµ‹è¯•ç”¨ä¾‹

**ä¼˜å…ˆçº§ï¼š** ä¸­

### é—®é¢˜ 3: é”™è¯¯ç å¤„ç†ä¸ä¸€è‡´

**é—®é¢˜æè¿°ï¼š**
æŸäº›å‡½æ•°ä½¿ç”¨ `ERR_get_error()` è·å–é”™è¯¯ï¼Œä½†æ²¡æœ‰æ¸…ç†é”™è¯¯é˜Ÿåˆ—ï¼Œå¯èƒ½å¯¼è‡´é”™è¯¯ç´¯ç§¯ã€‚

**å»ºè®®ï¼š**
- ç»Ÿä¸€é”™è¯¯å¤„ç†æ¨¡å¼
- ç¡®ä¿åœ¨é€‚å½“çš„åœ°æ–¹æ¸…ç†é”™è¯¯é˜Ÿåˆ—
- ä½¿ç”¨ `ERR_clear_error()` æˆ–åœ¨æ–‡æ¡£ä¸­å»ºè®®ç”¨æˆ·è°ƒç”¨ `openssl.errors()`

**ä¼˜å…ˆçº§ï¼š** ä¸­

---

## 2. OpenSSL ç‰ˆæœ¬å…¼å®¹æ€§çŸ©é˜µä¸åºŸå¼ƒæ¥å£å‡çº§

### 2.1 æ”¯æŒçš„ OpenSSL ç‰ˆæœ¬çŸ©é˜µ

| OpenSSL ç‰ˆæœ¬ | æ”¯æŒçŠ¶æ€ | ä¸»è¦å…¼å®¹æ€§é—®é¢˜ | æµ‹è¯•çŠ¶æ€ |
|-------------|---------|--------------|---------|
| 1.0.0 - 1.0.2u | éƒ¨åˆ†æ”¯æŒ | éœ€è¦å¤§é‡å…¼å®¹ä»£ç  | å·²æµ‹è¯• |
| 1.1.0 - 1.1.1w | å®Œå…¨æ”¯æŒ | åºŸå¼ƒ API è­¦å‘Š | å·²æµ‹è¯• |
| 3.0.0 - 3.0.18 | æ”¯æŒ | ä½çº§ API è®¿é—®å—é™ | å·²æµ‹è¯• |
| 3.5.x - 3.6.0 | æ”¯æŒ | æ–°ç‰¹æ€§æœªå®Œå…¨åˆ©ç”¨ | å·²æµ‹è¯• |
| LibreSSL 3.3.6+ | æ”¯æŒ | æŸäº›ç‰¹æ€§ä¸å¯ç”¨ | å·²æµ‹è¯• |


### 2.2 ç‰ˆæœ¬ç‰¹å®šåŠŸèƒ½

#### OpenSSL 1.1.0 å¼•å…¥çš„æ–°ç‰¹æ€§

- âœ… è‡ªåŠ¨åˆå§‹åŒ–/æ¸…ç†
- âœ… çº¿ç¨‹å®‰å…¨æ”¹è¿›
- âš ï¸ ä¸é€æ˜ç»“æ„ä½“ï¼ˆéƒ¨åˆ†ä½¿ç”¨ä½çº§è®¿é—®ï¼‰

#### OpenSSL 1.1.1 å¼•å…¥çš„æ–°ç‰¹æ€§

- âš ï¸ TLS 1.3 æ”¯æŒï¼ˆéœ€è¦æµ‹è¯•ï¼‰
- âŒ EdDSA (Ed25519/Ed448) - **å»ºè®®æ·»åŠ **
- âŒ X25519/X448 å¯†é’¥äº¤æ¢ - **å»ºè®®æ·»åŠ **

#### OpenSSL 3.0.0 å¼•å…¥çš„æ–°ç‰¹æ€§

- âœ… Provider æ¶æ„ï¼ˆåŸºæœ¬æ”¯æŒï¼‰
- âœ… **OSSL_PARAM API - å·²ç”¨äº EVP_PKEY ç§é’¥æ£€æµ‹** âœ…
- âŒ å¯è·å–å¯¹è±¡ï¼ˆFetchable objectsï¼‰- **å»ºè®®æ·»åŠ **
- âŒ æ–°çš„ç¼–ç /è§£ç  API - **å»ºè®®è¯„ä¼°**

#### OpenSSL 3.0+ åºŸå¼ƒè­¦å‘Šå¤„ç†ç­–ç•¥

**å®æ–½ç­–ç•¥è¯´æ˜ï¼š**
è¿™äº›æ¨¡å—ä½¿ç”¨äº†é€‚å½“çš„åºŸå¼ƒ API å¤„ç†ç­–ç•¥ï¼š
1. **å¯¹äºå¯ä»¥è¿ç§»çš„ API**ï¼šè¿ç§»åˆ°ç°ä»£æ›¿ä»£æ–¹æ¡ˆï¼ˆå¦‚ DH æ¨¡å—åœ¨ OpenSSL 3.0+ ä¸­ä½¿ç”¨ EVP_PKEY APIï¼‰
2. **å¯¹äºå¿…é¡»ä¿ç•™çš„ API**ï¼šä½¿ç”¨ pragma æŒ‡ä»¤æŠ‘åˆ¶è­¦å‘Šï¼Œå¹¶æ·»åŠ æ¸…æ™°çš„æ–‡æ¡£è¯´æ˜åŸå› 
3. **è·¨ç‰ˆæœ¬å…¼å®¹æ€§**ï¼šä½¿ç”¨æ¡ä»¶ç¼–è¯‘æ”¯æŒ OpenSSL 1.1.xã€3.0+ å’Œ LibreSSL

**åç»­å»ºè®®ï¼š**
è¿™äº›å‰©ä½™çš„è­¦å‘Šæ¶‰åŠå¤§é‡ä»£ç é‡æ„ï¼Œå»ºè®®åœ¨ç‹¬ç«‹çš„ PR ä¸­é€æ­¥å¤„ç†ï¼Œå¹¶éœ€è¦ï¼š
1. è¯„ä¼°è¿ç§»åˆ° Provider API çš„å½±å“
2. ç¡®ä¿ä¸ OpenSSL 1.1.x çš„å®Œå…¨å‘åå…¼å®¹æ€§
3. å…¨é¢çš„æµ‹è¯•ä»¥éªŒè¯åŠŸèƒ½ä¸å˜

#### OpenSSL 3.2.0+ å¼•å…¥çš„æ–°ç‰¹æ€§

- âŒ QUIC æ”¯æŒ - **å»ºè®®æ·»åŠ **
- âŒ æ”¹è¿›çš„ KDF API - **å»ºè®®è¯„ä¼°**

---

## 3. ç¼ºå¤±çš„é€šç”¨åŠ å¯†åº“åŠŸèƒ½

### 3.1 ç°ä»£å¯†ç å­¦ç®—æ³•æ”¯æŒ

#### 3.1.1 ç¼ºå¤±çš„ç­¾åç®—æ³•

| ç®—æ³• | OpenSSLç‰ˆæœ¬ | ä¼˜å…ˆçº§ | ç”¨é€” | å®ç°éš¾åº¦ |
|------|------------|--------|------|---------|
| **Ed25519** | 1.1.1+ | **é«˜** | ç°ä»£æ•°å­—ç­¾åï¼Œæ¯”RSAå¿« | ä¸­ |
| **Ed448** | 1.1.1+ | ä¸­ | é«˜å®‰å…¨æ€§ç­¾å | ä¸­ |
| EdDSA é€šç”¨æ¥å£ | 1.1.1+ | é«˜ | ç»Ÿä¸€çš„EdDSAæ¥å£ | ä¸­ |

**å»ºè®®å®ç°ï¼š**

```lua
-- ç¤ºä¾‹ API
local pkey = openssl.pkey.new('ed25519')
local signature = pkey:sign(message)
local verified = pkey:verify(message, signature)
```

#### 3.1.2 ç¼ºå¤±çš„å¯†é’¥äº¤æ¢ç®—æ³•

| ç®—æ³• | OpenSSLç‰ˆæœ¬ | ä¼˜å…ˆçº§ | ç”¨é€” | å®ç°éš¾åº¦ |
|------|------------|--------|------|---------|
| **X25519** | 1.1.0+ | **é«˜** | ç°ä»£ECDHï¼ŒTLS 1.3é»˜è®¤ | ä¸­ |
| **X448** | 1.1.0+ | ä¸­ | é«˜å®‰å…¨æ€§å¯†é’¥äº¤æ¢ | ä¸­ |

#### 3.1.3 ç¼ºå¤±çš„å¯†ç å¥—ä»¶

| ç®—æ³• | OpenSSLç‰ˆæœ¬ | ä¼˜å…ˆçº§ | ç”¨é€” | å®ç°éš¾åº¦ |
|------|------------|--------|------|---------|
| **ChaCha20-Poly1305** | 1.1.0+ | **é«˜** | ç°ä»£AEADï¼Œç§»åŠ¨è®¾å¤‡å‹å¥½ | ä½ |
| XChaCha20-Poly1305 | éœ€è¦å¤–éƒ¨ | ä½ | æ‰©å±•nonceçš„ChaCha20 | é«˜ |
| AES-GCM-SIV | éœ€è¦å¤–éƒ¨ | ä½ | è¯¯ç”¨æŠµæŠ—çš„AEAD | é«˜ |

**å½“å‰çŠ¶æ€ï¼š** é¡¹ç›®æœ‰ GCM æ”¯æŒçš„ç¤ºä¾‹ï¼ˆREADME ç¤ºä¾‹8ï¼‰ï¼Œä½†åº”éªŒè¯å®Œæ•´æ€§ã€‚

### 3.2 å¯†é’¥æ´¾ç”Ÿå‡½æ•°ï¼ˆKDFï¼‰

**ä½ç½®ï¼š** `src/kdf.c` - å·²å­˜åœ¨ä½†éœ€éªŒè¯å®Œæ•´æ€§

| KDF | OpenSSLç‰ˆæœ¬ | å½“å‰çŠ¶æ€ | ä¼˜å…ˆçº§ | å¤‡æ³¨ |
|-----|------------|---------|--------|------|
| PBKDF2 | æ‰€æœ‰ç‰ˆæœ¬ | âœ… å·²å®ç° | - | å¸¸ç”¨äºå¯†ç æ´¾ç”Ÿ |
| HKDF | 1.1.0+ | âœ… å·²å®ç° | - | ç°ä»£KDFï¼ŒTLS 1.3ä½¿ç”¨ |
| scrypt | 1.1.0+ | â“ éœ€éªŒè¯ | é«˜ | å†…å­˜å›°éš¾ï¼Œå¯†ç å“ˆå¸Œ |
| Argon2 | éœ€è¦å¤–éƒ¨ | âŒ æœªå®ç° | ä¸­ | æœ€æ–°å¯†ç å“ˆå¸Œæ ‡å‡† |
| TLS1.2 PRF | æ‰€æœ‰ç‰ˆæœ¬ | âœ… å·²å®ç° | - | - |
| TLS1.3 KDF | 1.1.1+ | â“ éœ€éªŒè¯ | ä¸­ | - |

**å»ºè®®ï¼š** æ·»åŠ  scrypt æ”¯æŒæ–‡æ¡£å’Œæµ‹è¯•ï¼Œè€ƒè™‘ Argon2ï¼ˆå¯èƒ½éœ€è¦å¤–éƒ¨åº“ï¼‰ã€‚

### 3.3 å¯†é’¥å°è£…æœºåˆ¶ï¼ˆKEMï¼‰

| åŠŸèƒ½ | OpenSSLç‰ˆæœ¬ | å½“å‰çŠ¶æ€ | ä¼˜å…ˆçº§ | å¤‡æ³¨ |
|-----|------------|---------|--------|------|
| RSA-KEM | 1.0.0+ | âŒ æœªå®ç° | ä¸­ | åŸºäºRSAçš„å¯†é’¥å°è£… |
| ECDH-KEM | 1.0.0+ | âš ï¸ éƒ¨åˆ† | ä¸­ | é€šè¿‡ECDHå¯å®ç° |
| **åé‡å­KEM** | 3.2.0+ (OQS) | âŒ æœªå®ç° | ä½ | æœªæ¥éœ€æ±‚ |

### 3.4 å¯†ç å­¦å“ˆå¸ŒåŠŸèƒ½

#### 3.4.1 ç°æœ‰æ”¯æŒï¼ˆé€šè¿‡ EVP_MDï¼‰

- âœ… MD5, SHA-1, SHA-2 ç³»åˆ— (SHA-224, SHA-256, SHA-384, SHA-512)
- âœ… SHA-3 ç³»åˆ—ï¼ˆéœ€è¦éªŒè¯ï¼‰
- âœ… BLAKE2ï¼ˆéœ€è¦éªŒè¯ OpenSSL ç‰ˆæœ¬æ”¯æŒï¼‰
- âš ï¸ SM3ï¼ˆä¸­å›½æ ‡å‡†ï¼Œéœ€è¦éªŒè¯ï¼‰

#### 3.4.2 ç¼ºå¤±çš„å“ˆå¸ŒåŠŸèƒ½

| åŠŸèƒ½ | ä¼˜å…ˆçº§ | ç”¨é€” | å®ç°éš¾åº¦ |
|-----|--------|------|---------|
| **å¯†ç å“ˆå¸Œå°è£…** | é«˜ | ç®€åŒ–å¸¸è§å¯†ç å“ˆå¸Œä»»åŠ¡ | ä½ |
| bcrypt | ä¸­ | å¯†ç å“ˆå¸Œï¼ˆéœ€è¦å¤–éƒ¨åº“ï¼‰ | é«˜ |
| Argon2 | ä¸­ | ç°ä»£å¯†ç å“ˆå¸Œ | é«˜ |

**å»ºè®®ï¼š** æ·»åŠ é«˜çº§å¯†ç å“ˆå¸ŒAPIï¼Œå°è£… PBKDF2/scryptï¼š
```lua
-- å»ºè®®çš„é«˜çº§ API
local hashed = openssl.password.hash('mypassword', {
  algorithm = 'pbkdf2',
  hash = 'sha256',
  iterations = 100000
})
local verified = openssl.password.verify('mypassword', hashed)
```

### 3.5 è¯ä¹¦å’ŒPKIåŠŸèƒ½

**ä½ç½®ï¼š** `src/x509.c`, `src/crl.c`, `src/csr.c`, `src/ocsp.c`

| åŠŸèƒ½ | å½“å‰çŠ¶æ€ | ä¼˜å…ˆçº§ | å¤‡æ³¨ |
|-----|---------|--------|------|
| X.509 è¯ä¹¦è§£æ | âœ… å·²å®ç° | - | å®Œæ•´ |
| X.509 è¯ä¹¦ç”Ÿæˆ | âœ… å·²å®ç° | - | å®Œæ•´ |
| CSR ç”Ÿæˆ/è§£æ | âœ… å·²å®ç° | - | å®Œæ•´ |
| CRL å¤„ç† | âœ… å·²å®ç° | - | å®Œæ•´ |
| OCSP | âœ… å·²å®ç° | - | å®Œæ•´ |
| **æ—¶é—´æˆ³ï¼ˆTimestampï¼‰** | âœ… å·²å®ç° | - | `src/ots.c` |
| **è¯ä¹¦é€æ˜åº¦ï¼ˆCTï¼‰** | âŒ æœªå®ç° | ä¸­ | ç°ä»£PKIéœ€æ±‚ |
| **è¯ä¹¦ç­–ç•¥éªŒè¯** | âš ï¸ éƒ¨åˆ† | ä¸­ | éœ€è¦éªŒè¯å®Œæ•´æ€§ |
| **åç§°çº¦æŸ** | âš ï¸ éƒ¨åˆ† | ä½ | éœ€è¦éªŒè¯ |

### 3.6 åŠ å¯†æ¶ˆæ¯æ ¼å¼

**ä½ç½®ï¼š** `src/pkcs7.c`, `src/cms.c`, `src/pkcs12.c`

| æ ¼å¼ | å½“å‰çŠ¶æ€ | ä¼˜å…ˆçº§ | å¤‡æ³¨ |
|-----|---------|--------|------|
| PKCS#7 | âœ… å·²å®ç° | - | ä¼ ç»Ÿæ ¼å¼ |
| CMS | âœ… å·²å®ç° | - | ç°ä»£æ›¿ä»£å“ |
| PKCS#12 | âœ… å·²å®ç° | - | è¯ä¹¦/å¯†é’¥å®¹å™¨ |
| **JWE** | âŒ æœªå®ç° | é«˜ | JSON Web Encryption |
| **JOSE** | âŒ æœªå®ç° | é«˜ | JSON åŠ å¯†å¯¹è±¡ |

**å»ºè®®ï¼š** JWE/JOSE å¯èƒ½éœ€è¦ä½œä¸ºç‹¬ç«‹æ¨¡å—å®ç°ï¼Œå› ä¸ºæ¶‰åŠ JSON å¤„ç†ã€‚

### 3.7 åè®®æ”¯æŒ

**ä½ç½®ï¼š** `src/ssl.c` (SSL/TLS), `src/srp.c` (SRP)

| åè®® | å½“å‰çŠ¶æ€ | ä¼˜å…ˆçº§ | å¤‡æ³¨ |
|-----|---------|--------|------|
| SSL/TLS | âœ… å·²å®ç° | - | å®Œæ•´æ”¯æŒ |
| DTLS | âœ… å·²å®ç° | - | æœ‰æµ‹è¯•ç”¨ä¾‹ |
| SRP | âœ… å·²å®ç° | - | å®‰å…¨è¿œç¨‹å¯†ç  |
| **QUIC** | âŒ æœªå®ç° | ä¸­ | OpenSSL 3.2+ |
| SSH | âŒ æœªå®ç° | ä½ | è¶…å‡ºèŒƒå›´ |

### 3.8 ç¡¬ä»¶/åŠ é€Ÿæ”¯æŒ

**ä½ç½®ï¼š** `src/engine.c`

| åŠŸèƒ½ | å½“å‰çŠ¶æ€ | ä¼˜å…ˆçº§ | å¤‡æ³¨ |
|-----|---------|--------|------|
| Engine API | âœ… å·²å®ç° | - | OpenSSL 1.x/3.x å…¼å®¹ |
| **Provider API** | âš ï¸ åŸºç¡€ | é«˜ | OpenSSL 3.0+ æ–°æ¶æ„ |
| ç¡¬ä»¶åŠ é€Ÿ | âš ï¸ é€šè¿‡Engine | ä¸­ | éœ€è¦æµ‹è¯• |

**å»ºè®®ï¼š** å¢å¼º Provider API æ”¯æŒï¼Œè¿™æ˜¯ OpenSSL 3.0+ çš„æœªæ¥æ–¹å‘ã€‚

### 3.9 å®ç”¨å·¥å…·åŠŸèƒ½

| åŠŸèƒ½ | å½“å‰çŠ¶æ€ | ä¼˜å…ˆçº§ | å»ºè®® |
|-----|---------|--------|------|
| Hex ç¼–ç /è§£ç  | âœ… å·²å®ç° | - | - |
| Base64 ç¼–ç /è§£ç  | âœ… å·²å®ç° | - | - |
| **Base64URL** | âŒ æœªå®ç° | ä¸­ | JWTéœ€è¦ |
| ASN.1 å¤„ç† | âœ… å·²å®ç° | - | `src/asn1.c` |
| **PEM å¯†ç å›è°ƒ** | âš ï¸ éƒ¨åˆ† | ä¸­ | éªŒè¯å®Œæ•´æ€§ |
| **å¯†é’¥æ ¼å¼è½¬æ¢** | âš ï¸ éƒ¨åˆ† | ä¸­ | PKCS#8, SEC1ç­‰ |

---

## 4. OpenSSL æ–°ç‰ˆæœ¬åŠŸèƒ½å®ç°è·¯çº¿å›¾

### 4.1 çŸ­æœŸç›®æ ‡ï¼ˆ1-3ä¸ªæœˆï¼‰

#### 4.1.1 ä¿®å¤åºŸå¼ƒAPIä½¿ç”¨ âœ… **å·²å®Œæˆ**

**ç›®æ ‡ï¼š** æ¶ˆé™¤å…³é”®æ¨¡å—çš„ OpenSSL åºŸå¼ƒ API è­¦å‘Š

**å‰©ä½™å·¥ä½œï¼š**

ä»¥ä¸‹æ¨¡å—çš„åºŸå¼ƒè­¦å‘Šéœ€è¦åç»­è¯„ä¼°ï¼š
- `src/pkey.c`: 127 ä¸ªè­¦å‘Š - ä½çº§å¯†é’¥æ“ä½œï¼Œéœ€è¦ä¿æŒå‘åå…¼å®¹æ€§
- `src/rsa.c`: 44 ä¸ªè­¦å‘Š - RSA åº•å±‚å‡½æ•°ç»‘å®š

#### 4.1.2 å¢å¼ºé”™è¯¯å¤„ç†ï¼ˆä¼˜å…ˆçº§ï¼šé«˜ï¼‰

**ä»»åŠ¡ï¼š**
- [ ] å®¡è®¡æ‰€æœ‰é”™è¯¯è·¯å¾„çš„èµ„æºæ¸…ç†
  - æ–‡ä»¶ï¼šæ‰€æœ‰ `src/*.c`
  - å·¥å…·ï¼šé™æ€åˆ†æï¼ˆCoverity, clang-analyzerï¼‰
  - é¢„è®¡å·¥ä½œé‡ï¼š3-5å¤©

- [ ] æ ‡å‡†åŒ–é”™è¯¯æŠ¥å‘Šæ¨¡å¼
  - ç¡®ä¿ä¸€è‡´ä½¿ç”¨ `openssl_pushresult()`
  - æ–‡æ¡£åŒ–é”™è¯¯å¤„ç†çº¦å®š
  - é¢„è®¡å·¥ä½œé‡ï¼š2å¤©

- [ ] æ·»åŠ é”™è¯¯å¤„ç†æµ‹è¯•
  - åˆ›å»ºé”™è¯¯æ³¨å…¥æµ‹è¯•
  - éªŒè¯å†…å­˜æ¸…ç†ï¼ˆValgrindï¼‰
  - é¢„è®¡å·¥ä½œé‡ï¼š2å¤©

#### 4.1.3 æ–‡æ¡£æ”¹è¿›ï¼ˆä¼˜å…ˆçº§ï¼šé«˜ï¼‰

**ä»»åŠ¡ï¼š**
- [ ] åˆ›å»ºç‰ˆæœ¬å…¼å®¹æ€§æ–‡æ¡£
  - åŸºäºæœ¬æ–‡æ¡£
  - æ·»åŠ è¿ç§»æŒ‡å—
  - é¢„è®¡å·¥ä½œé‡ï¼š2å¤©

- [ ] æ›´æ–°APIæ–‡æ¡£
  - æ ‡è®°åºŸå¼ƒå‡½æ•°
  - æ·»åŠ ç‰ˆæœ¬è¦æ±‚
  - é¢„è®¡å·¥ä½œé‡ï¼š3å¤©

### 4.2 ä¸­æœŸç›®æ ‡ï¼ˆ3-6ä¸ªæœˆï¼‰

#### 4.2.1 OpenSSL 3.0 å…¨é¢æ”¯æŒï¼ˆä¼˜å…ˆçº§ï¼šé«˜ï¼‰

**ç›®æ ‡ï¼š** å……åˆ†åˆ©ç”¨ OpenSSL 3.0 ç‰¹æ€§ï¼ŒåŒæ—¶ä¿æŒå‘åå…¼å®¹

**ä»»åŠ¡æ¸…å•ï¼š**

1. **OSSL_PARAM API æ”¯æŒ**
   - [ ] åˆ›å»º Lua ç»‘å®šç”¨äº `OSSL_PARAM`
   - [ ] è¿ç§»å¯†é’¥å‚æ•°è®¿é—®åˆ° PARAM API
   - é¢„è®¡å·¥ä½œé‡ï¼š7å¤©
   - æ–‡ä»¶ï¼šæ–°å»º `src/param.c` æ‰©å±•æˆ–é‡æ„

2. **å¯è·å–å¯¹è±¡ï¼ˆFetchable Objectsï¼‰**
   - [ ] å®ç° `EVP_MD_fetch()`, `EVP_CIPHER_fetch()` ç»‘å®š
   - [ ] æ”¯æŒç®—æ³•å±æ€§æŸ¥è¯¢
   - é¢„è®¡å·¥ä½œé‡ï¼š5å¤©
   - æ–‡ä»¶ï¼š`src/digest.c`, `src/cipher.c`

**ç¤ºä¾‹ä»£ç ï¼š**
```c
// OpenSSL 3.0+ æ–¹å¼ï¼ˆå·²å®ç°ï¼‰
#if OPENSSL_VERSION_NUMBER >= 0x30000000L && !defined(LIBRESSL_VERSION_NUMBER)
  // å…ˆå°è¯• PARAM API
  ret = openssl_pkey_has_private_bn_param(pkey, OSSL_PKEY_PARAM_RSA_D);
  if (ret < 0) {
    // Legacy key - fallback
    RSA *rsa = (RSA *)EVP_PKEY_get0_RSA(pkey);
    const BIGNUM *d = NULL;
    RSA_get0_key(rsa, NULL, NULL, &d);
    ret = d != NULL;
  }
#else
  // OpenSSL 1.x æ–¹å¼
  const RSA *rsa = EVP_PKEY_get0_RSA(pkey);
  const BIGNUM *n, *e;
  RSA_get0_key(rsa, &n, &e, NULL);
#endif
```

#### 4.2.2 ç°ä»£å¯†ç å­¦ç®—æ³•ï¼ˆä¼˜å…ˆçº§ï¼šé«˜ï¼‰

**1. Ed25519/Ed448 æ”¯æŒ**
   - [ ] å¯†é’¥ç”Ÿæˆ
   - [ ] ç­¾å/éªŒè¯
   - [ ] PEM/DER å¯¼å…¥/å¯¼å‡º
   - é¢„è®¡å·¥ä½œé‡ï¼š5å¤©
   - æ–‡ä»¶ï¼š`src/pkey.c`
   - æµ‹è¯•ï¼šæ–°å»º `test/ed25519.lua`

**2. X25519/X448 å¯†é’¥äº¤æ¢**
   - [ ] å¯†é’¥æ´¾ç”Ÿ
   - [ ] ECDH å…¼å®¹API
   - é¢„è®¡å·¥ä½œé‡ï¼š3å¤©
   - æ–‡ä»¶ï¼š`src/ec.c` æˆ– `src/pkey.c`

**3. ChaCha20-Poly1305**
   - [ ] éªŒè¯ç°æœ‰æ”¯æŒ
   - [ ] æ·»åŠ æ–‡æ¡£å’Œç¤ºä¾‹
   - [ ] æµ‹è¯•å¥—ä»¶
   - é¢„è®¡å·¥ä½œé‡ï¼š2å¤©
   - æ–‡ä»¶ï¼š`src/cipher.c`
   - æµ‹è¯•ï¼šæ‰©å±• `test/3.cipher.lua`

#### 4.2.3 KDF å®Œå–„ï¼ˆä¼˜å…ˆçº§ï¼šä¸­ï¼‰

**ä»»åŠ¡ï¼š**
- [ ] éªŒè¯å¹¶æ–‡æ¡£åŒ– scrypt æ”¯æŒ
- [ ] æ·»åŠ  TLS 1.3 KDF ç»‘å®šï¼ˆå¦‚æœç¼ºå¤±ï¼‰
- [ ] åˆ›å»ºç»Ÿä¸€çš„ KDF API
  ```lua
  local key = openssl.kdf.derive({
    type = 'hkdf',
    hash = 'sha256',
    salt = salt,
    info = info,
    key = ikm,
    length = 32
  })
  ```
- é¢„è®¡å·¥ä½œé‡ï¼š5å¤©
- æ–‡ä»¶ï¼š`src/kdf.c`

### 4.3 é•¿æœŸç›®æ ‡ï¼ˆ6-12ä¸ªæœˆï¼‰

#### 4.3.1 QUIC æ”¯æŒï¼ˆä¼˜å…ˆçº§ï¼šä¸­ï¼‰

**å‰ææ¡ä»¶ï¼š** OpenSSL 3.2.0+

**ä»»åŠ¡ï¼š**
- [ ] ç ”ç©¶ OpenSSL QUIC API
- [ ] è®¾è®¡ Lua API
- [ ] å®ç°åŸºæœ¬ QUIC åŠŸèƒ½
- [ ] SSL/TLS é›†æˆ
- é¢„è®¡å·¥ä½œé‡ï¼š15-20å¤©
- æ–‡ä»¶ï¼šæ–°å»º `src/quic.c`
- æµ‹è¯•ï¼šæ–°å»º `test/quic.lua`

#### 4.3.2 JWE/JOSE æ”¯æŒï¼ˆä¼˜å…ˆçº§ï¼šä¸­-ä½ï¼‰

**ä»»åŠ¡ï¼š**
- [ ] è¯„ä¼°æ˜¯å¦ä½œä¸ºç‹¬ç«‹æ¨¡å—
- [ ] JSON ä¾èµ–å¤„ç†ï¼ˆå¯èƒ½éœ€è¦ lua-cjsonï¼‰
- [ ] å®ç° JWE åŠ å¯†/è§£å¯†
- [ ] å®ç° JWS ç­¾å/éªŒè¯
- é¢„è®¡å·¥ä½œé‡ï¼š20å¤©
- æ–‡ä»¶ï¼šæ–°å»º `src/jose.c` æˆ–ç‹¬ç«‹ä»“åº“

#### 4.3.3 åé‡å­å¯†ç å­¦ï¼ˆä¼˜å…ˆçº§ï¼šä½ï¼‰

**æ³¨æ„ï¼š** é«˜åº¦å®éªŒæ€§ï¼Œä¾èµ– OQS-OpenSSL

**ä»»åŠ¡ï¼š**
- [ ] è°ƒç ” OpenSSL åé‡å­æ”¯æŒçŠ¶æ€
- [ ] è¯„ä¼°é›†æˆ liboqs
- [ ] å®ç° ML-KEMï¼ˆKyberï¼‰ç»‘å®š
- [ ] å®ç° ML-DSAï¼ˆDilithiumï¼‰ç»‘å®š
- é¢„è®¡å·¥ä½œé‡ï¼š25+ å¤©
- æ—¶é—´æ¡†æ¶ï¼šè§† OpenSSL é‡‡ç”¨æƒ…å†µè€Œå®š

#### 4.3.4 æ€§èƒ½ä¼˜åŒ–ï¼ˆä¼˜å…ˆçº§ï¼šä¸­ï¼‰

**ä»»åŠ¡ï¼š**
- [ ] åˆ†ææ€§èƒ½ç“¶é¢ˆ
  - ä½¿ç”¨ LuaJIT profiler
  - OpenSSL æ€§èƒ½åˆ†æ

- [ ] ä¼˜åŒ–é¢‘ç¹è°ƒç”¨è·¯å¾„
  - å‡å°‘Lua-Cè¾¹ç•Œè·¨è¶Š
  - æ‰¹é‡æ“ä½œAPI

- [ ] é›¶æ‹·è´ä¼˜åŒ–
  - ç›´æ¥ç¼“å†²åŒºæ“ä½œ
  - `lightuserdata` ç”¨äºå¤§æ•°æ®

- é¢„è®¡å·¥ä½œé‡ï¼š10-15å¤©

### 4.4 æŒç»­ä»»åŠ¡

#### 4.4.1 æµ‹è¯•è¦†ç›–ç‡æå‡

**å½“å‰çŠ¶æ€ï¼š** åŸºç¡€æµ‹è¯•å­˜åœ¨ï¼Œéœ€è¦æ‰©å±•

**ä»»åŠ¡ï¼š**
- [ ] æ·»åŠ è¾¹ç•Œæƒ…å†µæµ‹è¯•
- [ ] é”™è¯¯è·¯å¾„æµ‹è¯•
- [ ] æ€§èƒ½åŸºå‡†æµ‹è¯•
- [ ] å¤šç‰ˆæœ¬å…¼å®¹æ€§æµ‹è¯•
- [ ] å†…å­˜æ³„æ¼æµ‹è¯•ï¼ˆValgrindé›†æˆï¼‰

**å·¥å…·ï¼š**
- LuaUnitï¼ˆå·²ä½¿ç”¨ï¼‰
- Coverage å·¥å…·
- CI/CD è‡ªåŠ¨åŒ–

#### 4.4.2 CI/CD å¢å¼º

**å½“å‰çŠ¶æ€ï¼š** GitHub Actions æµ‹è¯•å¤šç‰ˆæœ¬

**æ”¹è¿›ï¼š**
- [ ] æ·»åŠ é™æ€åˆ†æï¼ˆcppcheck, clang-tidyï¼‰
- [ ] å†…å­˜æ£€æŸ¥ï¼ˆValgrind, AddressSanitizerï¼‰
- [ ] è¦†ç›–ç‡æŠ¥å‘Šï¼ˆgcov/lcovï¼‰
- [ ] åºŸå¼ƒAPIæ£€æŸ¥
- [ ] æ–‡æ¡£ç”Ÿæˆå’ŒéªŒè¯

#### 4.4.3 å®‰å…¨å®¡è®¡

**ä»»åŠ¡ï¼š**
- [ ] å®šæœŸå®‰å…¨å®¡æŸ¥
- [ ] ä¾èµ–é¡¹æ›´æ–°ç›‘æ§
- [ ] CVE è·Ÿè¸ªå’Œå“åº”
- [ ] å®‰å…¨æœ€ä½³å®è·µæ–‡æ¡£

---

## 5. å®ç°ä¼˜å…ˆçº§æ€»ç»“

### è¿‘æœŸï¼ˆæœ¬æœˆï¼‰

4. ğŸ” é”™è¯¯å¤„ç†å®¡è®¡å’Œä¿®å¤
5. ğŸ“ åˆ›å»ºç‰ˆæœ¬å…¼å®¹æ€§æ–‡æ¡£
6. ğŸ§ª å¢å¼ºæµ‹è¯•å¥—ä»¶

### çŸ­æœŸï¼ˆ1-3ä¸ªæœˆï¼‰

7. ğŸ†• OpenSSL 3.0 Provider API æ”¯æŒ
8. ğŸ†• Ed25519/Ed448 å®ç°
9. ğŸ”„ è¯„ä¼° HMAC æ¨¡å—è¿ç§»åˆ° EVP_MAC

### ä¸­æœŸï¼ˆ3-6ä¸ªæœˆï¼‰

10. ğŸ†• OSSL_PARAM API ç»‘å®š
11. ğŸ†• X25519/X448 å®ç°
12. ğŸ” KDF åŠŸèƒ½å®Œå–„
13. ğŸ”„ è¯„ä¼° ENGINE æ¨¡å—è¿ç§»åˆ° Provider API

### é•¿æœŸï¼ˆ6-12ä¸ªæœˆï¼‰

14. ğŸ†• QUIC æ”¯æŒ
15. ğŸ†• JWE/JOSE è€ƒè™‘
16. ğŸ”¬ åé‡å­å¯†ç å­¦ç ”ç©¶

---

## 6. ç»“è®ºå’Œå»ºè®®

### 6.1 æ€»ä½“è¯„ä¼°

lua-openssl æ˜¯ä¸€ä¸ªåŠŸèƒ½ä¸°å¯Œçš„ OpenSSL ç»‘å®šï¼Œå…·æœ‰ä»¥ä¸‹ä¼˜ç‚¹ï¼š

- âœ… **å¹¿æ³›çš„åŠŸèƒ½è¦†ç›–**ï¼šæ”¯æŒå¤§å¤šæ•°æ ¸å¿ƒ OpenSSL åŠŸèƒ½
- âœ… **è‰¯å¥½çš„å…¼å®¹æ€§**ï¼šæ”¯æŒ OpenSSL 1.0.0 åˆ° 3.6.0
- âœ… **æ´»è·ƒç»´æŠ¤**ï¼šå®šæœŸæ›´æ–°å’Œæµ‹è¯•
- âœ… **å®Œæ•´çš„æµ‹è¯•**ï¼šå¤šç‰ˆæœ¬ CI/CD

**éœ€è¦æ”¹è¿›çš„é¢†åŸŸï¼š**

- âš ï¸ **åºŸå¼ƒ API ä½¿ç”¨**ï¼šéœ€è¦ç°ä»£åŒ–ä»£ç åº“
- âš ï¸ **OpenSSL 3.0 ç‰¹æ€§**ï¼šæœªå……åˆ†åˆ©ç”¨æ–°æ¶æ„
- âš ï¸ **ç°ä»£ç®—æ³•æ”¯æŒ**ï¼šç¼ºå°‘ Ed25519, X25519 ç­‰
- âš ï¸ **é”™è¯¯å¤„ç†**ï¼šéœ€è¦å®¡è®¡å’Œæ ‡å‡†åŒ–
- âš ï¸ **æ–‡æ¡£**ï¼šéœ€è¦æ›´è¯¦ç»†çš„ API æ–‡æ¡£å’Œç¤ºä¾‹

### 6.2 å…³é”®å»ºè®®

#### å¯¹ç»´æŠ¤è€…ï¼š

1. **ä¼˜å…ˆä¿®å¤åºŸå¼ƒ API**ï¼šè¿™ä¼šæ¶ˆé™¤è­¦å‘Šå¹¶æé«˜æœªæ¥å…¼å®¹æ€§
2. **åˆ›å»º OpenSSL 3.0 è·¯çº¿å›¾**ï¼šPARAM API æ˜¯æœªæ¥æ–¹å‘
3. **å¢åŠ ç°ä»£ç®—æ³•**ï¼šEd25519/X25519 æ˜¯è¡Œä¸šæ ‡å‡†
4. **æ”¹è¿›æ–‡æ¡£**ï¼šåŒ…æ‹¬ç‰ˆæœ¬å…¼å®¹æ€§å’Œè¿ç§»æŒ‡å—
5. **å»ºç«‹å®‰å…¨æµç¨‹**ï¼šCVE å“åº”å’Œå®šæœŸå®¡è®¡

#### å¯¹ç”¨æˆ·ï¼š

1. **ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬**ï¼šç¡®ä¿è·å¾—å®‰å…¨ä¿®å¤
2. **è´¡çŒ®æµ‹è¯•ç”¨ä¾‹**ï¼šå¸®åŠ©å‘ç°å…¼å®¹æ€§é—®é¢˜
3. **æŠ¥å‘Šé—®é¢˜**ï¼šç‰¹åˆ«æ˜¯ä¸æ–° OpenSSL ç‰ˆæœ¬ç›¸å…³çš„é—®é¢˜
4. **åˆ†äº«ç”¨ä¾‹**ï¼šå¸®åŠ©ç¡®å®šåŠŸèƒ½ä¼˜å…ˆçº§

### 6.3 æˆåŠŸæŒ‡æ ‡

**çŸ­æœŸï¼ˆ3ä¸ªæœˆï¼‰ï¼š**

- âœ… é›¶åºŸå¼ƒ API è­¦å‘Š
- âœ… æ”¹è¿›çš„é”™è¯¯å¤„ç†è¦†ç›–ç‡
- âœ… å®Œæ•´çš„ç‰ˆæœ¬å…¼å®¹æ€§æ–‡æ¡£

**ä¸­æœŸï¼ˆ6ä¸ªæœˆï¼‰ï¼š**

- âœ… OpenSSL 3.0 Provider API æ”¯æŒ
- âœ… Ed25519/X25519 å®ç°
- âœ… å¢å¼ºçš„æµ‹è¯•å¥—ä»¶ï¼ˆ80%+ è¦†ç›–ç‡ï¼‰

**é•¿æœŸï¼ˆ12ä¸ªæœˆï¼‰ï¼š**

- âœ… å…¨é¢çš„ OpenSSL 3.0+ æ”¯æŒ
- âœ… ç°ä»£å¯†ç å­¦ç®—æ³•å®Œæ•´æ”¯æŒ
- âœ… QUIC æ”¯æŒï¼ˆå¦‚æœç›¸å…³ï¼‰

---

## é™„å½• A: å‚è€ƒèµ„æº

### OpenSSL æ–‡æ¡£
- [OpenSSL 3.0 è¿ç§»æŒ‡å—](https://www.openssl.org/docs/man3.0/man7/migration_guide.html)
- [OpenSSL 3.0 Provider æ–‡æ¡£](https://www.openssl.org/docs/man3.0/man7/provider.html)
- [OpenSSL Wiki](https://wiki.openssl.org/)

### ç›¸å…³é¡¹ç›®
- [OpenSSL](https://github.com/openssl/openssl)
- [LibreSSL](https://www.libressl.org/)
- [BoringSSL](https://boringssl.googlesource.com/boringssl/)

### Lua åŠ å¯†åº“
- [lua-resty-openssl](https://github.com/fffonion/lua-resty-openssl) - å¦ä¸€ä¸ª OpenSSL ç»‘å®š
- [luacrypto](https://github.com/mkottman/luacrypto) - è¾ƒæ—§çš„åŠ å¯†åº“

---

## é™„å½• B: è´¡çŒ®æŒ‡å—

å¦‚æœæ‚¨æƒ³å®ç°ä¸Šè¿°ä»»ä½•åŠŸèƒ½ï¼š

1. **è®¨è®º**ï¼šåœ¨ GitHub issue ä¸­æå‡º
2. **è®¾è®¡**ï¼šåˆ†äº« API è®¾è®¡ä»¥è·å¾—åé¦ˆ
3. **å®ç°**ï¼šéµå¾ªç°æœ‰ä»£ç é£æ ¼ï¼ˆclang-formatï¼‰
4. **æµ‹è¯•**ï¼šæ·»åŠ å…¨é¢çš„æµ‹è¯•ç”¨ä¾‹
5. **æ–‡æ¡£**ï¼šæ›´æ–° LDoc æ³¨é‡Šå’Œ README
6. **PR**ï¼šæäº¤ pull request å¹¶å“åº”å®¡æŸ¥

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** 1.1
**åˆ›å»ºæ—¥æœŸï¼š** 2025-11-09
**ä½œè€…ï¼š** Code Review Analysis
**çŠ¶æ€ï¼š** åˆå§‹ç‰ˆæœ¬
