name: CI

on:
  push:
    branches: [ "master", "ci" ]
    tags:
      - v?[0-9].[0-9]+.[0-9]+-[0-9]+
  pull_request:
    # The branches below must be a subset of the branches above
    branches: [ "master" ]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read
    strategy:
      matrix:
        os: [macos-15-intel, ubuntu-latest]
        luarocks_version: [3.12.0]
        lua_version: [luajit2.1, lua5.1, lua5.3, lua5.4]
        openssl_version: [openssl-1.0.2u, openssl-1.1.1w, openssl-3.0.18, openssl-3.5.4, openssl-3.6.0]
    env:
      MACOSX_DEPLOYMENT_TARGET: 10.12
      LUAROCKS: ${{ matrix.luarocks_version }}
      LUA: ${{ matrix.lua_version }}
      SSL: ${{ matrix.openssl_version }}

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup
      run:
        .github/shell/setup_lua.sh && .github/shell/setup_ssl.sh

    - name: Build
      run:
        .github/shell/build.sh

    - name: Test
      run:
        PKG_CONFIG_PATH=$HOME/.usr/lib64/pkgconfig:$HOME/.usr/lib/pkgconfig PATH=$HOME/.usr/bin:$PATH LD_LIBRARY_PATH=$HOME/.usr/lib64:$HOME/.usr/lib make test

  build-msvc:
    runs-on: windows-latest
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        arch: [amd64, x86]
        openssl_version: [openssl-1.1.1w, openssl-3.0.18, openssl-3.5.4]

    steps:
    - name: Setup MSVC Developer Prompt
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: ${{ matrix.arch }}

    - name: Check Prerequisites
      run: |
        Write-Host "Checking Perl..."
        perl --version
        Write-Host "Checking 7z..."
        7z --help
        Write-Host "Architecture: ${{ matrix.arch }}"
        Write-Host "OpenSSL Version: ${{ matrix.openssl_version }}"

    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup LuaJIT
      run: |
        Write-Host "Cloning LuaJIT..."
        git clone https://github.com/LuaJIT/LuaJIT.git C:\luajit
        if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
        
        Write-Host "Building LuaJIT..."
        cd C:\luajit\src
        cmd /c "msvcbuild.bat"
        if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
        
        Write-Host "Copying LuaJIT files..."
        copy luajit.exe C:\
        copy lua51.* C:\
        
        Write-Host "LuaJIT setup complete"
        C:\luajit.exe -v

    - name: Setup OpenSSL
      run: |
        $ErrorActionPreference = "Stop"
        $SSL = "${{ matrix.openssl_version }}"
        $VERSION = $SSL -replace "openssl-", ""
        $IS_OPENSSL_1X = $VERSION -match "^1\."
        
        Write-Host "Setting up OpenSSL $VERSION"
        
        # Download OpenSSL
        if ($VERSION -match "^(0\.9\.|1\.0\.0|1\.0\.1|1\.0\.2|1\.1\.1)") {
          $CONVERTED = $VERSION -replace "\.", "_"
          $URL = "https://github.com/openssl/openssl/releases/download/OpenSSL_$CONVERTED/$SSL.tar.gz"
        } else {
          $URL = "https://github.com/openssl/openssl/releases/download/$SSL/$SSL.tar.gz"
        }
        
        Write-Host "Downloading from: $URL"
        curl -L $URL -o "$SSL.tar.gz"
        if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
        
        Write-Host "Extracting..."
        7z x "$SSL.tar.gz" -so | 7z x -aoa -si -ttar
        if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
        
        cd $SSL
        
        # Configure based on architecture
        if ("${{ matrix.arch }}" -eq "x86") {
          $PREFIX = "C:\openssl-win32"
          $CONFIGURE_TARGET = "VC-WIN32"
          $DO_BATCH = "ms\do_ms.bat"
          Write-Host "Configuring for x86..."
        } else {
          $PREFIX = "C:\openssl-win64"
          $CONFIGURE_TARGET = "VC-WIN64A"
          $DO_BATCH = "ms\do_win64a.bat"
          Write-Host "Configuring for x64..."
        }
        
        perl Configure --prefix=$PREFIX no-asm no-shared $CONFIGURE_TARGET
        if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
        
        if ($IS_OPENSSL_1X) {
          Write-Host "Building OpenSSL 1.x..."
          cmd /c $DO_BATCH
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
          nmake -f ms\nt.mak
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
          nmake -f ms\nt.mak install
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
        } else {
          Write-Host "Building OpenSSL 3.x..."
          nmake
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
          nmake install
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
        }
        
        Write-Host "OpenSSL setup complete"

    - name: Update config.win
      run: |
        $VERSION = "${{ matrix.openssl_version }}" -replace "openssl-", ""
        $IS_OPENSSL_1X = $VERSION -match "^1\."
        
        if ("${{ matrix.arch }}" -eq "x86") {
          $PREFIX = "C:\openssl-win32"
        } else {
          $PREFIX = "C:\openssl-win64"
        }
        
        if ($IS_OPENSSL_1X) {
          $LIBS = """$PREFIX\lib\libeay32.lib $PREFIX\lib\ssleay32.lib"""
        } else {
          $LIBS = """$PREFIX\lib\libcrypto.lib $PREFIX\lib\libssl.lib"""
        }
        
        "# Installation directories" | Out-File -FilePath config.win -Encoding ASCII
        "# System's libraries directory (where binary libraries are installed)" | Out-File -FilePath config.win -Append -Encoding ASCII
        "" | Out-File -FilePath config.win -Append -Encoding ASCII
        "# Lua includes and lib" | Out-File -FilePath config.win -Append -Encoding ASCII
        'LUA_INC= "c:\luajit\src"' | Out-File -FilePath config.win -Append -Encoding ASCII
        'LUA_LIB= "c:\luajit\src\lua51.lib"' | Out-File -FilePath config.win -Append -Encoding ASCII
        "" | Out-File -FilePath config.win -Append -Encoding ASCII
        "# Openssl include and lib" | Out-File -FilePath config.win -Append -Encoding ASCII
        "OPENSSL_INC=""$PREFIX\include""" | Out-File -FilePath config.win -Append -Encoding ASCII
        "OPENSSL_LIB=$LIBS" | Out-File -FilePath config.win -Append -Encoding ASCII
        "" | Out-File -FilePath config.win -Append -Encoding ASCII
        'LIBNAME= $T.dll' | Out-File -FilePath config.win -Append -Encoding ASCII
        "" | Out-File -FilePath config.win -Append -Encoding ASCII
        "# Compilation directives" | Out-File -FilePath config.win -Append -Encoding ASCII
        "WARN= /O2" | Out-File -FilePath config.win -Append -Encoding ASCII
        'INCS= /I$(LUA_INC) /I$(OPENSSL_INC) /Ideps' | Out-File -FilePath config.win -Append -Encoding ASCII
        'CFLAGS= /DWIN32_LEAN_AND_MEAN /MD $(WARN) $(INCS)' | Out-File -FilePath config.win -Append -Encoding ASCII
        "CC= cl" | Out-File -FilePath config.win -Append -Encoding ASCII
        "" | Out-File -FilePath config.win -Append -Encoding ASCII

    - name: Build
      run: |
        Write-Host "Building lua-openssl..."
        nmake -f Makefile.win lib
        if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
        Write-Host "Build complete"
        dir src\openssl.dll

    - name: Test
      run: |
        Write-Host "Running tests..."
        cd test
        $env:LUA_PATH = "?.lua;"
        $env:LUA_CPATH = "C:\?.dll;..\src\?.dll"
        C:\luajit.exe test.lua
        if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
        Write-Host "Tests complete"

  deploy:
    if: startsWith(github.ref, 'refs/tags/')
    needs: [build, build-msvc]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      WITH_LUA_ENGINE: LuaJIT
      LUA: luajit2.1
      LUAROCKS: 3.12.0
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Get version
      id: get_version
      run: echo ::set-output name=VERSION::${GITHUB_REF#refs/tags/}

    - name: Setup
      run:
        .github/shell/setup_lua.sh

    - name: Package
      run:
        .github/shell/make_rockspec.sh ${{ steps.get_version.outputs.VERSION }}

    - name: Github Release
      id: create_release
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}
      with:
        files: openssl-${{ steps.get_version.outputs.VERSION }}.tar.gz
        draft: false
        prerelease: false

    - name: Luarocks Release
      # lua-cjson is required for luarocks upload
      run: |
        export PATH=$HOME/.usr/bin:$PATH
        export LUA_CPATH=$HOME/.usr/lib/lua/5.1/?.so
        luarocks install lua-cjson
        luarocks build
        luarocks test
        luarocks upload openssl-${{ steps.get_version.outputs.VERSION }}.rockspec --api-key=${{ secrets.LUAROCKS_TOKEN }}
